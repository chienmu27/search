<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>éºå¤±ç‰©ç…§ç‰‡ç®¡ç†ç³»çµ±</title>

    <style>
        :root { --primary: #4285f4; --danger: #dc3545; --bg: #f8f9fa; --card: #fff; --text: #333; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; color: var(--text); }

        /* è¼‰å…¥é®ç½© */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.3s;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #errorMsg { color: var(--danger); margin-top: 15px; font-weight: bold; display: none; }
        #forceCloseBtn { margin-top: 20px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; }

        /* é©—è­‰å½ˆçª— */
        #modalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        #modalBox {
            background: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }
        #modalTitle { margin-top: 0; color: var(--primary); }
        #modalDesc { font-size: 0.9em; margin-bottom: 15px; color: #666; }
        #pwdInput { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #btnConfirm { background: var(--primary); color: #fff; }
        #btnCancel { background: #eee; color: #333; }

        /* ä»‹é¢æ¨£å¼ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .refresh-btn { background: none; border: 1px solid #ddd; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; }
        .refresh-btn:hover { background: #eee; }

        .upload-box { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }

        input[type="file"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button.action-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        button.action-btn:hover { opacity: 0.9; }

        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .filter-btn { background: #fff; border: 1px solid #ddd; padding: 5px 15px; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .img-wrap { height: 150px; background: #eee; overflow: hidden; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .img-wrap img:hover { transform: scale(1.05); }
        .info { padding: 10px; }
        .name { font-weight: bold; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .cat-tag { font-size: 0.75em; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #555; }
        .btn-del { background: #fff0f0; color: var(--danger); border: 1px solid #ffcccc; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; cursor: pointer; }
        .btn-del:hover { background: var(--danger); color: white; border-color: var(--danger); }
    </style>
</head>

<body>

<div id="loadingOverlay">
    <div class="spinner" id="spinner"></div>
    <div id="loadingText" style="margin-top:15px; color:#555;">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <div id="errorMsg"></div>
    <button id="forceCloseBtn" onclick="forceHideLoading()">é—œé–‰è¦–çª—</button>
</div>

<div id="modalOverlay">
    <div id="modalBox">
        <h3 id="modalTitle">é©—è­‰</h3>
        <p id="modalDesc">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
        <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <div class="modal-btns">
            <button id="btnCancel">å–æ¶ˆ</button>
            <button id="btnConfirm">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <h3 style="margin:0;">ğŸ“‚ éºå¤±ç‰©ç…§ç‰‡ç®¡ç†</h3>
        <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ æ‰‹å‹•é‡æ–°æ•´ç†</button>
    </div>

    <div class="upload-box">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <input type="text" id="catInput" list="catList" placeholder="è¼¸å…¥åˆ†é¡ (æ•´æ‰¹)">
        <datalist id="catList"></datalist>
        <button class="action-btn" onclick="prepareUpload()">æ‰¹æ¬¡ä¸Šå‚³</button>
    </div>

    <div class="filters" id="filterBox"></div>
    <div class="gallery" id="galleryBox"></div>
</div>

<script>
    // ============================================
    // ã€è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€ã€‘
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydZH-DPr010ezQAxKIFMZX3PPY6duJeo0lWP0-HTJup1sasKI2uFDyPu6ESj8jOGFH/exec";
    // ============================================

    let allPhotos = [];
    let currentAction = null;
    let targetId = null;
    let isFetching = false;
    let hasLoadedOnce = false;

    // --- 1. è®€å–ç…§ç‰‡ ---
    function fetchPhotos() {
        if (isFetching) return;
        isFetching = true;

        if (hasLoadedOnce) showLoading(true, "æ›´æ–°åˆ—è¡¨ä¸­...");

        const timestamp = Date.now();

        fetch(`${SCRIPT_URL}?v=${timestamp}`, {
            method: "GET",
            cache: "no-store"
        })
        .then(res => res.json())
        .then(data => {
            allPhotos = Array.isArray(data) ? data : [];
            renderUI();
            hasLoadedOnce = true;
            showLoading(false);
        })
        .catch(err => {
            console.error("è®€å–å¤±æ•—:", err);

            const txt = document.getElementById('loadingText');
            if (txt) txt.innerText = "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– SCRIPT_URL";

            const btn = document.getElementById('forceCloseBtn');
            if (btn) btn.style.display = 'block';

            const spinner = document.getElementById('spinner');
            if (spinner) spinner.style.display = 'none';

            setTimeout(() => showLoading(false), 3500);
        })
        .finally(() => {
            isFetching = false;
        });
    }

    function manualRefresh() {
        fetchPhotos();
    }

    // --- 2. æº–å‚™ä¸Šå‚³ ---
    function prepareUpload() {
        const files = document.getElementById('fileInput').files;
        if (files.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç…§ç‰‡"); return; }

        for (let i = 0; i < files.length; i++) {
            if (files[i].size > 5 * 1024 * 1024) {
                alert(`æª”æ¡ˆ "${files[i].name}" éå¤§ (>5MB)ï¼Œè«‹ç§»é™¤å¾Œå†è©¦`);
                return;
            }
        }
        openModal('upload', null, "æ‰¹æ¬¡ä¸Šå‚³é©—è­‰", `å…±é¸æ“‡ ${files.length} å¼µç…§ç‰‡ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š`);
    }

    // --- 3. æº–å‚™åˆªé™¤ ---
    window.prepareDelete = function(id) {
        if (!id) { alert("éŒ¯èª¤ï¼šID ç„¡æ•ˆ"); return; }
        openModal('delete', id, "ç¢ºèªåˆªé™¤ç…§ç‰‡", "åˆªé™¤å¾Œå°‡ç§»è‡³é›²ç«¯åƒåœ¾æ¡¶ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š");
    };

    // --- å½ˆçª—é‚è¼¯ ---
    const modal = document.getElementById('modalOverlay');
    const pwdInput = document.getElementById('pwdInput');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');

    function openModal(action, id, title, desc) {
        currentAction = action;
        targetId = id;
        modalTitle.innerText = title;
        modalDesc.innerText = desc || "è«‹è¼¸å…¥å¯†ç¢¼ï¼š";
        pwdInput.value = "";
        modal.style.display = 'flex';
        setTimeout(() => pwdInput.focus(), 50);
    }

    document.getElementById('btnCancel').onclick = () => modal.style.display = 'none';

    document.getElementById('btnConfirm').onclick = () => {
        const pwd = pwdInput.value;
        if (!pwd) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
        modal.style.display = 'none';

        if (currentAction === 'upload') doBatchUpload(pwd);
        if (currentAction === 'delete') doDelete(pwd);
    };

    // Enter ç›´æ¥ç¢ºèª
    pwdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById('btnConfirm').click();
    });

    // --- æ‰¹æ¬¡ä¸Šå‚³ ---
    async function doBatchUpload(password) {
        const files = document.getElementById('fileInput').files;
        const category = document.getElementById('catInput').value.trim() || "æœªåˆ†é¡";
        const total = files.length;
        let successCount = 0;
        let failCount = 0;

        showLoading(true, "æº–å‚™é–‹å§‹ä¸Šå‚³...");

        for (let i = 0; i < total; i++) {
            const file = files[i];
            const txt = document.getElementById('loadingText');
            if (txt) txt.innerText = `æ­£åœ¨ä¸Šå‚³ (${i + 1} / ${total}): ${file.name}`;

            try {
                const base64Data = await readFileAsBase64(file);
                const result = await uploadSingleFile(base64Data, file.name, file.type, category, password);

                if (result && result.status === 'success') {
                    successCount++;
                } else {
                    failCount++;
                }
            } catch (err) {
                console.error(err);
                failCount++;
            }
        }

        showLoading(false);
        alert(`è™•ç†å®Œæˆã€‚\næˆåŠŸ: ${successCount} å¼µ\nå¤±æ•—: ${failCount} å¼µ`);

        if (successCount > 0) {
            document.getElementById('fileInput').value = "";
            document.getElementById('catInput').value = "";
            fetchPhotos();
        }
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(file);
        });
    }

    function uploadSingleFile(base64Data, filename, mimeType, category, password) {
        return fetch(SCRIPT_URL, {
            method: 'POST',
            cache: "no-store",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
                action: 'upload',
                password: password,
                file: base64Data,
                filename: filename,
                mimeType: mimeType,
                category: category
            })
        }).then(res => res.json());
    }

    // --- åˆªé™¤ ---
    function doDelete(password) {
        showLoading(true, "åˆªé™¤ä¸­...");

        fetch(SCRIPT_URL, {
            method: 'POST',
            cache: "no-store",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
                action: 'delete',
                password: password,
                id: String(targetId)
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data && data.status === 'success') {
                alert("åˆªé™¤æˆåŠŸï¼");
                allPhotos = allPhotos.filter(p => String(p.id) !== String(targetId));
                renderUI();
                showLoading(false);
            } else {
                alert("åˆªé™¤å¤±æ•—: " + (data?.message || "æœªçŸ¥éŒ¯èª¤"));
                showLoading(false);
            }
        })
        .catch(err => {
            console.error(err);
            alert("é€£ç·šéŒ¯èª¤");
            showLoading(false);
        });
    }

    // --- æ¸²æŸ“ UI ---
    function renderUI() {
        const catBox = document.getElementById('filterBox');
        const galleryBox = document.getElementById('galleryBox');

        if (!allPhotos || allPhotos.length === 0) {
            catBox.innerHTML = '';
            galleryBox.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#999;">æ²’æœ‰ç…§ç‰‡ (è«‹ä¸Šå‚³)</p>';
            return;
        }

        const cats = ['å…¨éƒ¨', ...new Set(allPhotos.map(p => p.category || "æœªåˆ†é¡"))];
        const activeCat = document.querySelector('.filter-btn.active')?.innerText || 'å…¨éƒ¨';

        catBox.innerHTML = cats.map(c =>
            `<button class="filter-btn ${c === activeCat ? 'active' : ''}"
             onclick="changeFilter('${escapeHtml(c)}', this)">${escapeHtml(c)}</button>`
        ).join('');

        renderGallery(activeCat);

        document.getElementById('catList').innerHTML = cats
            .filter(c => c !== 'å…¨éƒ¨')
            .map(c => `<option value="${escapeHtml(c)}">`)
            .join('');
    }

    window.changeFilter = function(cat, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGallery(cat);
    };

    function renderGallery(filter) {
        const box = document.getElementById('galleryBox');
        const list = filter === 'å…¨éƒ¨'
            ? allPhotos
            : allPhotos.filter(p => (p.category || "æœªåˆ†é¡") === filter);

        if (list.length === 0) {
            box.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#999;">ç„¡æ­¤åˆ†é¡ç…§ç‰‡</p>';
            return;
        }

        box.innerHTML = list.map(p => `
            <div class="card">
                <div class="img-wrap">
                    <img src="${p.url}" alt="${escapeHtml(p.name || '')}" loading="lazy"
                     onerror="this.src='https://via.placeholder.com/200x150?text=Error'">
                </div>
                <div class="info">
                    <div class="name" title="${escapeHtml(p.name || '')}">${escapeHtml(p.name || '')}</div>
                    <div class="meta">
                        <span class="cat-tag">${escapeHtml(p.category || "æœªåˆ†é¡")}</span>
                        <button class="btn-del" onclick="prepareDelete('${String(p.id)}')">åˆªé™¤</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // --- Loading ---
    function showLoading(show, text) {
        const el = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingText');
        const spinner = document.getElementById('spinner');
        const btn = document.getElementById('forceCloseBtn');
        const err = document.getElementById('errorMsg');

        if (show) {
            el.style.display = 'flex';
            el.style.opacity = '1';
            if (text) txt.innerText = text;

            spinner.style.display = 'block';
            btn.style.display = 'none';
            err.style.display = 'none';

            setTimeout(() => {
                if (el.style.display === 'flex') {
                    btn.style.display = 'block';
                    if (txt.innerText.includes("åˆå§‹åŒ–")) txt.innerText = "é€£ç·šæ™‚é–“è¼ƒé•·...";
                }
            }, 15000);

        } else {
            el.style.opacity = '0';
            setTimeout(() => {
                if (el.style.opacity === '0') el.style.display = 'none';
            }, 300);
        }
    }

    window.forceHideLoading = function() {
        document.getElementById('loadingOverlay').style.display = 'none';
    };

    // --- é˜² XSS (åˆ†é¡/åç¨±æœ‰ç‰¹æ®Šå­—å…ƒæ™‚æ›´å®‰å…¨) ---
    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    // =========================================================
    // ã€å¼·åˆ¶è‡ªå‹•åŸ·è¡Œã€‘
    // =========================================================
    function initApp() {
        if (!SCRIPT_URL || SCRIPT_URL.length < 20) {
            const txt = document.getElementById('loadingText');
            if (txt) txt.innerText = "éŒ¯èª¤ï¼šSCRIPT_URL ç¶²å€ä¼¼ä¹ä¸æ­£ç¢º";
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('forceCloseBtn').style.display = 'block';
            return;
        }
        fetchPhotos();
    }

    initApp();

    // GitHub Pages æœ‰æ™‚å€™ load äº‹ä»¶è¼ƒæ™šï¼Œä¿éšªå†è£œä¸€æ¬¡
    window.addEventListener('load', () => {
        if (!hasLoadedOnce && !isFetching) initApp();
    });

    setTimeout(() => {
        if (!hasLoadedOnce && !isFetching) initApp();
    }, 2000);
</script>

</body>
</html>
