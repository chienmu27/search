<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>éºå¤±ç‰©ç…§ç‰‡ç®¡ç†ç³»çµ± (è‡ªå‹•ç·¨è™Ÿç‰ˆ)</title>

    <style>
        :root { --primary: #4285f4; --danger: #dc3545; --bg: #f8f9fa; --card: #fff; --text: #333; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; color: var(--text); }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #errorMsg { color: var(--danger); margin-top: 15px; font-weight: bold; display: none; }
        #forceCloseBtn {
            margin-top: 20px; padding: 8px 16px; background: #666; color: white;
            border: none; border-radius: 4px; cursor: pointer; display: none;
        }

        #modalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        #modalBox {
            background: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }
        #modalTitle { margin-top: 0; color: var(--primary); }
        #modalDesc { font-size: 0.9em; margin-bottom: 15px; color: #666; }
        #pwdInput {
            width: 100%; padding: 10px; margin-bottom: 20px;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button {
            flex: 1; padding: 10px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold;
        }
        #btnConfirm { background: var(--primary); color: #fff; }
        #btnCancel { background: #eee; color: #333; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .refresh-btn {
            background: none; border: 1px solid #ddd; padding: 5px 10px;
            cursor: pointer; border-radius: 4px; font-size: 0.8em;
        }
        .refresh-btn:hover { background: #eee; }

        .upload-box {
            background: var(--card); padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; gap: 10px; flex-wrap: wrap;
            margin-bottom: 20px; align-items: center;
        }
        input[type="file"], input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button.action-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        button.action-btn:hover { opacity: 0.9; }

        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .filter-btn { background: #fff; border: 1px solid #ddd; padding: 5px 15px; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card {
            background: var(--card); border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        .img-wrap { height: 150px; background: #eee; overflow: hidden; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .img-wrap img:hover { transform: scale(1.05); }
        .info { padding: 10px; }
        .name { font-weight: bold; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .cat-tag { font-size: 0.75em; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #555; }
        .btn-del {
            background: #fff0f0; color: var(--danger);
            border: 1px solid #ffcccc; padding: 4px 10px;
            border-radius: 4px; font-size: 0.8em; cursor: pointer;
        }
        .btn-del:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
    </style>
</head>

<body>

<div id="loadingOverlay">
    <div class="spinner" id="spinner"></div>
    <div id="loadingText" style="margin-top:15px; color:#555;">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <div id="errorMsg"></div>
    <button id="forceCloseBtn" onclick="forceHideLoading()">é—œé–‰è¦–çª—</button>
</div>

<div id="modalOverlay">
    <div id="modalBox">
        <h3 id="modalTitle">é©—è­‰</h3>
        <p id="modalDesc">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
        <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <div class="modal-btns">
            <button id="btnCancel">å–æ¶ˆ</button>
            <button id="btnConfirm">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <h3 style="margin:0;">ğŸ“‚ éºå¤±ç‰©ç…§ç‰‡ç®¡ç†</h3>
        <button class="refresh-btn" onclick="fetchPhotos()">ğŸ”„ æ‰‹å‹•é‡æ–°æ•´ç†</button>
    </div>

    <div class="upload-box">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <input type="text" id="catInput" list="catList" placeholder="è¼¸å…¥åˆ†é¡ (æ•´æ‰¹)">
        <datalist id="catList"></datalist>
        <button class="action-btn" onclick="prepareUpload()">æ‰¹æ¬¡ä¸Šå‚³</button>
    </div>

    <div class="filters" id="filterBox"></div>
    <div class="gallery" id="galleryBox"></div>
</div>

<script>
    // ============================================
    // ã€è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€ã€‘
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxx0t3Pz5DKYrPztCw07T8akmMzCcBZ9Dlzx-a5L9EmZS181SWgKzm-Wclz7Wg5cndDnA/exec";
    // ============================================

    let allPhotos = [];
    let currentAction = null;
    let targetId = null;
    let isFetching = false;
    let hasLoadedOnce = false;

    // -----------------------------
    // 1. è®€å–åˆ—è¡¨
    // -----------------------------
    function fetchPhotos() {
        if (isFetching) return;
        isFetching = true;

        if (hasLoadedOnce) showLoading(true, "æ›´æ–°åˆ—è¡¨ä¸­...");

        const timestamp = Date.now();

        fetch(`${SCRIPT_URL}?v=${timestamp}`, {
            method: "GET",
            cache: "no-store"
        })
        .then(res => res.json())
        .then(data => {
            allPhotos = Array.isArray(data) ? data : [];
            renderUI();
            hasLoadedOnce = true;
            showLoading(false);
        })
        .catch(err => {
            console.error(err);
            const txt = document.getElementById('loadingText');
            const spinner = document.getElementById('spinner');
            const btn = document.getElementById('forceCloseBtn');

            if (txt) txt.innerText = "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– SCRIPT_URL";
            if (spinner) spinner.style.display = "none";
            if (btn) btn.style.display = "block";

            setTimeout(() => showLoading(false), 3500);
        })
        .finally(() => {
            isFetching = false;
        });
    }

    // -----------------------------
    // 2. æº–å‚™ä¸Šå‚³
    // -----------------------------
    function prepareUpload() {
        const files = document.getElementById('fileInput').files;
        if (files.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç…§ç‰‡"); return; }

        // æª¢æŸ¥å¤§å° (30MB)
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > 30 * 1024 * 1024) {
                alert(`æª”æ¡ˆ "${files[i].name}" éå¤§ (>30MB)ï¼Œè«‹ç§»é™¤`);
                return;
            }
        }
        openModal('upload', null, "æ‰¹æ¬¡ä¸Šå‚³é©—è­‰", `å…± ${files.length} å¼µï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š`);
    }

    // -----------------------------
    // 3. æº–å‚™åˆªé™¤
    // -----------------------------
    window.prepareDelete = function(id) {
        if (!id) return;
        openModal('delete', id, "ç¢ºèªåˆªé™¤ç…§ç‰‡", "åˆªé™¤å¾Œå°‡ç§»è‡³åƒåœ¾æ¡¶ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š");
    };

    // -----------------------------
    // å½ˆçª—
    // -----------------------------
    const modal = document.getElementById('modalOverlay');
    const pwdInput = document.getElementById('pwdInput');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');

    function openModal(action, id, title, desc) {
        currentAction = action;
        targetId = id;
        modalTitle.innerText = title;
        modalDesc.innerText = desc || "è«‹è¼¸å…¥å¯†ç¢¼ï¼š";
        pwdInput.value = "";
        modal.style.display = 'flex';
        setTimeout(() => pwdInput.focus(), 50);
    }

    document.getElementById('btnCancel').onclick = () => modal.style.display = 'none';

    document.getElementById('btnConfirm').onclick = () => {
        const pwd = pwdInput.value;
        if (!pwd) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
        modal.style.display = 'none';

        if (currentAction === 'upload') doBatchUpload(pwd);
        if (currentAction === 'delete') doDelete(pwd);
    };

    // Enter ç›´æ¥ç¢ºèª
    pwdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("btnConfirm").click();
    });

    // -----------------------------
    // æ‰¹æ¬¡ä¸Šå‚³ (åˆ†ç‰‡ä¸Šå‚³)
    // -----------------------------
    async function doBatchUpload(password) {
        const files = document.getElementById('fileInput').files;
        const category = document.getElementById('catInput').value.trim() || "æœªåˆ†é¡";
        let success = 0, fail = 0;

        showLoading(true, "æº–å‚™ä¸Šå‚³...");

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const uniqueId = Date.now().toString() + "_" + i;

            try {
                const fullBase64 = await readFileAsBase64(file);
                const cleanBase64 = fullBase64.split(',')[1];

                // åˆ†ç‰‡ (1.5MB)
                const CHUNK_SIZE = 1.5 * 1024 * 1024;
                const totalChunks = Math.ceil(cleanBase64.length / CHUNK_SIZE);
                let finalName = "";

                for (let j = 0; j < totalChunks; j++) {
                    const chunk = cleanBase64.slice(j * CHUNK_SIZE, (j + 1) * CHUNK_SIZE);
                    const pct = Math.round(((j + 1) / totalChunks) * 100);

                    const txt = document.getElementById('loadingText');
                    if (txt) {
                        txt.innerText = `æ­£åœ¨ä¸Šå‚³ (${i + 1}/${files.length}): ${file.name} (${pct}%)`;
                    }

                    const result = await sendChunk({
                        action: 'upload_chunk',
                        password: password,
                        fileId: uniqueId,
                        chunk: chunk,
                        index: j,
                        total: totalChunks,
                        filename: file.name,
                        mimeType: file.type,
                        category: category
                    });

                    if (!result || result.status === 'error') {
                        throw new Error(result?.message || "ä¸Šå‚³å¤±æ•—");
                    }

                    // æœ€å¾Œä¸€ç‰‡æœƒå›å‚³æ–°æª”å
                    if (result.name) finalName = result.name;
                }

                console.log(`ä¸Šå‚³æˆåŠŸ: ${file.name} -> ${finalName}`);
                success++;
            } catch (err) {
                console.error(err);
                fail++;
            }
        }

        showLoading(false);
        alert(`å®Œæˆã€‚\næˆåŠŸ: ${success}\nå¤±æ•—: ${fail}`);

        if (success > 0) {
            document.getElementById('fileInput').value = "";
            fetchPhotos();
        }
    }

    function sendChunk(payload) {
        return fetch(SCRIPT_URL, {
            method: 'POST',
            cache: "no-store",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        }).then(res => res.json());
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // -----------------------------
    // åˆªé™¤
    // -----------------------------
    function doDelete(password) {
        showLoading(true, "åˆªé™¤ä¸­...");

        fetch(SCRIPT_URL, {
            method: 'POST',
            cache: "no-store",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
                action: 'delete',
                password: password,
                id: String(targetId)
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data && data.status === 'success') {
                alert("åˆªé™¤æˆåŠŸ");

                // ä¿®æ­£ï¼šé¿å… id å‹åˆ¥ä¸ä¸€è‡´é€ æˆåˆªä¸æ‰
                allPhotos = allPhotos.filter(p => String(p.id) !== String(targetId));

                renderUI();
            } else {
                alert("å¤±æ•—: " + (data?.message || "æœªçŸ¥éŒ¯èª¤"));
            }
        })
        .catch(err => {
            console.error(err);
            alert("é€£ç·šéŒ¯èª¤");
        })
        .finally(() => showLoading(false));
    }

    // -----------------------------
    // æ¸²æŸ“ UI
    // -----------------------------
    function renderUI() {
        const catBox = document.getElementById('filterBox');
        const galleryBox = document.getElementById('galleryBox');

        if (!allPhotos || allPhotos.length === 0) {
            catBox.innerHTML = '';
            galleryBox.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1">æ²’æœ‰ç…§ç‰‡</p>';
            return;
        }

        const cats = ['å…¨éƒ¨', ...new Set(allPhotos.map(p => p.category || "æœªåˆ†é¡"))];
        const activeCat = document.querySelector('.filter-btn.active')?.innerText || 'å…¨éƒ¨';

        catBox.innerHTML = cats.map(c => `
            <button class="filter-btn ${c === activeCat ? 'active' : ''}"
                onclick="changeFilter('${escapeJsString(c)}', this)">
                ${escapeHtml(c)}
            </button>
        `).join('');

        renderGallery(activeCat);

        // datalist ä¸æ”¾ã€Œå…¨éƒ¨ã€æ¯”è¼ƒåˆç†
        document.getElementById('catList').innerHTML = cats
            .filter(c => c !== "å…¨éƒ¨")
            .map(c => `<option value="${escapeHtml(c)}">`)
            .join('');
    }

    window.changeFilter = function(cat, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGallery(cat);
    };

    function renderGallery(filter) {
        const box = document.getElementById('galleryBox');
        const list = (filter === 'å…¨éƒ¨')
            ? allPhotos
            : allPhotos.filter(p => (p.category || "æœªåˆ†é¡") === filter);

        if (list.length === 0) {
            box.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1">ç„¡æ­¤åˆ†é¡ç…§ç‰‡</p>';
            return;
        }

        box.innerHTML = list.map(p => `
            <div class="card">
                <div class="img-wrap">
                    <img src="${p.url}"
                         alt="${escapeHtml(p.name || '')}"
                         loading="lazy"
                         onerror="this.src='https://via.placeholder.com/200?text=Error'">
                </div>
                <div class="info">
                    <div class="name" title="${escapeHtml(p.name || '')}">
                        ${escapeHtml(p.name || '')}
                    </div>
                    <div class="meta">
                        <span class="cat-tag">${escapeHtml(p.category || 'æœªåˆ†é¡')}</span>
                        <button class="btn-del" onclick="prepareDelete('${String(p.id)}')">åˆªé™¤</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // -----------------------------
    // Loading
    // -----------------------------
    function showLoading(show, text) {
        const el = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingText');
        const btn = document.getElementById('forceCloseBtn');
        const spinner = document.getElementById('spinner');

        if (show) {
            el.style.display = 'flex';
            el.style.opacity = '1';

            if (text) txt.innerText = text;
            btn.style.display = 'none';
            spinner.style.display = 'block';

            setTimeout(() => {
                if (el.style.display === 'flex') btn.style.display = 'block';
            }, 15000);

        } else {
            el.style.opacity = '0';
            setTimeout(() => {
                if (el.style.opacity === '0') el.style.display = 'none';
            }, 300);
        }
    }

    window.forceHideLoading = () => {
        document.getElementById('loadingOverlay').style.display = 'none';
    };

    // -----------------------------
    // å®‰å…¨è™•ç†
    // -----------------------------
    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    // é¿å…åˆ†é¡åç¨±å« ' é€ æˆ onclick å£æ‰
    function escapeJsString(str) {
        return String(str).replaceAll("\\", "\\\\").replaceAll("'", "\\'");
    }

    // -----------------------------
    // åˆå§‹åŒ–
    // -----------------------------
    function initApp() {
        if (!SCRIPT_URL || SCRIPT_URL.length < 20) {
            document.getElementById('loadingText').innerText = "éŒ¯èª¤ï¼šSCRIPT_URL ç¶²å€ç„¡æ•ˆ";
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('forceCloseBtn').style.display = 'block';
            return;
        }
        fetchPhotos();
    }

    initApp();

    window.addEventListener('load', () => {
        if (!hasLoadedOnce && !isFetching) initApp();
    });

    setTimeout(() => {
        if (!hasLoadedOnce && !isFetching) initApp();
    }, 2000);
</script>

</body>
</html>
